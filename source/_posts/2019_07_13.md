---
title: Prometheus+grafana监控告警系统
date: 2019-07-13
tags: [Grafana,Prometheus]
categories: 监控系统
---

介绍
Prometheus是一个开源的系统监控和报警的工具包，最初由SoundCloud发布。
特点：
● 多维数据模型（有metric名称和键值对确定的时间序列）
● 灵活的查询语言
● 不依赖分布式存储
● 通过pull方式采集时间序列，通过http协议传输
● 支持通过中介网关的push时间序列的方式
● 监控数据通过服务或者静态配置来发现
● 支持图表和dashboard等多种方式

Prometheus 生态圈中包含了多个组件，其中许多组件是可选的：
● Prometheus Server: 用于收集和存储时间序列数据。
● Client Library: 客户端库，为需要监控的服务生成相应的 metrics 并暴露给 Prometheus server。当 Prometheus server 来 pull 时，直接返回实时状态的 metrics。
● Push Gateway: 主要用于短期的 jobs。由于这类 jobs 存在时间较短，可能在 Prometheus 来 pull 之前就消失了。为此，这次 jobs 可以直接向 Prometheus server 端推送它们的 metrics。这种方式主要用于服务层面的 metrics，对于机器层面的 metrices，需要使用 node exporter。
● Exporters: 用于暴露已有的第三方服务的 metrics 给 Prometheus。
● Alertmanager: 从 Prometheus server 端接收到 alerts 后，会进行去除重复数据，分组，并路由到对收的接受方式，发出报警。常见的接收方式有：电子邮件，pagerduty，OpsGenie, webhook 等。
● 一些其他的工具。

### prometheus原理
```
1、prometheus server定期从配置好的jobs或exporters中拉取metrics，或者直接接收来自PushGateway发过来的metrics，或者从其他的prometheus server拉取metrics
2、prometheus server在本地存储收集到的metrics，并运行已定义好的alert.rules，记录新的时间序列或者向Alertmanager发生警告
3、Alertmanager根据配置文件，对接收到的告警进行处理，发出告警
4、在图形界面化，可视化采集数据
```

### 下载安装prometheus
```
官方下载地址：https://prometheus.io/download/
wget https://github.com/prometheus/prometheus/releases/download/v2.10.0/prometheus-2.10.0.linux-amd64.tar.gz
解压：
tar zxvf prometheus-2.10.0.linux-amd64.tar.gz
查看：
cd prometheus-2.10.0.linux-amd64.tar.gz
./prometheus --help
配置文件 prometheus.yml
    global:
        scrape_interval:     15s  # 默认15秒到目标处抓取数据
    scrape_configs:
        - job_name: prometheus
          static_configs:
            - targets: ['localhost:9090']

scrape_configs块，配置监控项。
prometheus可以自己暴露metric，这里配置为监控自己

启动
./prometheus --config.file=prometheus.yml
nohup ./prometheus --config.file=prometheus.yml &
访问，浏览器打开：ip:port(port默认9090)
ip:port/metrics  // 监控自己

修改配置文件后，重载方式：
curl -X POST http://localhost:9090/-/reload
```

### grafana图表化
```
加入data source
选择 prometheus
settings
url地址： ip:9090
dashboards
import导入模版
直接查看面板即可
```

### node_exporter监控系统性能
```
下载：https://prometheus.io/download/
找到node_exporter下载
解压： tar -zxvf node_exporter-0.18.0.linux-amd64.tar.gz
移动： mv node_exporter-0.18.0.linux-amd64.tar.gz /usr/local/node_exporter
运行： ./node_exporter &
注意要在root用户下运行，为了获取系统cpu及内存信息

找grafana的模版：https://grafana.com/dashboards/8919
导入json即可
按照模版下面的说明，需要按照插件-饼图插件：grafana-cli plugins install grafana-piechart-panel
重启grafana service grafana-server restart
Q&A
1、如果没有数据，需要稍等一会，时序数据有了之后才能进行占比的计算
2、内存使用率不显示问题：内存使用率的panel,修改查询为如下
    (1 - (node_memory_MemFree_bytes{instance=~"$node"} / (node_memory_MemTotal_bytes{instance=~"$node"})))* 100
    最新版的node_exporter将node_memory_MemAvailable_bytes改为node_memory_MemFree_bytes了。
```