---
title: Telegraf+Influxdb+Grafana图表化实时监控分析数据
date: 2019-07-07
tags: [Grafana,Telegraf]
categories: 监控系统
---
本节开始，将展开多种监控系统的讨论。

>telegraf  
influxdb  
grafana

### 下载安装telegraf
```
service telegraf status管理
1、下载telegraf:
    https://portal.influxdata.com/downloads/
centos:
    wget https://dl.influxdata.com/telegraf/releases/telegraf-1.10.4-1.x86_64.rpm
    sudo yum localinstall telegraf-1.10.4-1.x86_64.rpm
ubuntu:
    wget https://dl.influxdata.com/telegraf/releases/telegraf_1.10.4-1_amd64.deb
    sudo dpkg -i telegraf_1.10.4-1_amd64.deb
Linux Binaries (64-bit)
    wget https://dl.influxdata.com/telegraf/releases/telegraf-1.10.4_linux_amd64.tar.gz
    tar xf telegraf-1.10.4_linux_amd64.tar.gz
    解压出来后，
    执行文件在 telegraf/usr/bin/telegraf
    配置文件在 telegraf/etc/telegraf/telegraf.conf

查看帮助
telegraf --help
生成配置文件(配置文件在安装后的etc目录下，也可直接配置生成)
在当前目录下生成配置文件
telegraf config > telegraf.conf

1、#生成带cpu、memroy、http_listener

输出到kafka插件的配置文件
telegraf --input-filter cpu:mem:http_listener --output-filter kafka config > /etc/telegraf/telegraf.conf

输出到influxdb插件的配置文件
#生成带cpu、memroy、http_listener和influxdb插件的配置文件
#telegraf --input-filter cpu:mem:http_listener --output-filter influxdb config > /etc/telegraf/telegraf.conf

想要追加监控信息可以直接加入：
    cpu:mem:http_listener:disk:diskio:kernel:processes:swap:system:net:netstat
    cpu ：系统CPU信息，如用户态和系统态利用率等等
    mem ：系统内存信息，如物理、虚拟、交换内存量等等。
    disk ：磁盘占用信息。
    diskio ：磁盘IO性能。
    net和netstat ：网卡和网络信息。
    system ：当前系统负载信息，类似uptime信息。
    file ：每个时间周期读取文件所有信息。

修改配置文件中的influxdb相关信息：
    ###############################################################################
    #                            OUTPUT PLUGINS                                   #
    ###############################################################################
    
    # Configuration for sending metrics to InfluxDB
    [[outputs.influxdb]]
    ...
    ...
    ## The full HTTP or UDP URL for your InfluxDB instance.
    urls = ["http://127.0.0.1:8086"]

    ## The target database for metrics; will be created as needed.
    database = "telegraf"

    ## Name of existing retention policy to write to.  Empty string writes to
    ## the default retention policy.  Only takes effect when using HTTP.
    retention_policy = ""

    ## Timeout for HTTP messages.
    timeout = "5s"

    ## HTTP Basic Auth
    username = "telegraf"
    password = "telegraf"

日志：/var/log/telegraf/telegraf.log

编辑conf文件：注释掉 加载 pem认证文件掉几行

2、创建消费者：
bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic telegraf --from-beginning

3、运行程序,执行程序
需要在root账号下
service telegraf restart

4、此时消费者接受到cpu信息和内存信息以及http响应信息
```

### 下载安装influxdb
```
service influxdb status管理
1、下载influxdb:
    https://portal.influxdata.com/downloads/
Ubuntu:
    wget https://dl.influxdata.com/influxdb/releases/influxdb_1.7.6_amd64.deb
    sudo dpkg -i influxdb_1.7.6_amd64.deb
Centos:
    wget https://dl.influxdata.com/influxdb/releases/influxdb-1.7.6.x86_64.rpm
    sudo yum localinstall influxdb-1.7.6.x86_64.rpm
Linux Binaries (64-bit)
    wget https://dl.influxdata.com/influxdb/releases/influxdb-1.7.6_linux_amd64.tar.gz
    tar xvfz influxdb-1.7.6_linux_amd64.tar.gz
    
启动：
root账号下
service influxdb start

启动influxdb客户端
influx
或者
influx -username 'name' -password 'passwd'

为了配合telegraf数据存入influxdb
1、创建telegraf中的账号密码
    create user telegraf with password 'telegraf' with all privileges
2、创建数据库
    create database telegraf
3、进入数据库
    use telegraf
4、查看表
    show measurements
5、修改完telegraf的配置文件重启后，等待一会
6、查看表
    表内有了数据cpu、mem内存
```

### 下载安装grafana
```
service grafana-server status管理
官方地址：https://grafana.com/grafana/download
ubuntu:
    wget https://dl.grafana.com/oss/release/grafana_6.2.1_amd64.deb 
    sudo dpkg -i grafana_6.2.1_amd64.deb 
centos:
    wget https://dl.grafana.com/oss/release/grafana-6.2.1-1.x86_64.rpm 
    sudo yum localinstall grafana-6.2.1-1.x86_64.rpm 
Linux Binaries(64 Bit)    
    wget https://dl.grafana.com/oss/release/grafana-6.2.1.linux-amd64.tar.gz 
    tar -zxvf grafana-6.2.1.linux-amd64.tar.gz 
mac:
    brew update
    brew install grafana

启动：
root账号下：
service grafana-server start
mac下：brew services start grafana   // 停止 brew services stop grafana

浏览器打开：ip:port (grafana默认端口为 3000)
第一次登陆默认账号命名为：admin admin
第一次登陆成功后会让你修改密码

官方模版：https://grafana.com/dashboards

配置data source:
    选择influxdb
    http-auth鉴权选择basic auth即可
    下面的user跟password填写正常的即可
配置dashboard：
    从官方模版 filter telegrah，选择Dynamic Dashboard，下载json文件
    grafana + import，选择上传刚刚下载的json文件即可
    然后选择源 --刚刚配置数据源中配置的名称
    保存即可
```

### grafana配置告警(email、钉钉)
```
email-修改/etc/grafana/grafana.ini配置文件
    # 邮件服务器配置，自行修改配置
    #################################### SMTP / Emailing ##########################
    [smtp]
    enabled = true  #是否允许开启
    host = smtp.exmail.qq.com:465    #发送服务器地址，可以再邮箱的配置教程中找到：
    user = 你的邮箱
    # If the password contains # or ; you have to wrap it with trippel quotes. Ex """#password;"""
    # 这个密码是你开启smtp服务生成的密码
    password = 你的密码
    ;cert_file =
    ;key_file =
    ;skip_verify = false
    from_address = 你的邮箱
    from_name = Grafana
    # EHLO identity in SMTP dialog (defaults to instance_name)
    ehlo_identity = dashboard.example.com
    
    [emails]
    ;welcome_email_on_sign_up = true
    
    #################################### Logging ##########################

重启grafana: service grafana-service restart

grafana配置告警接收方式
Alerting => Notification channels
添加一个email的，填写接收邮箱即可

钉钉的先去钉钉添加一个机器人拿到webhook地址
添加一个dingding的，把从钉钉机器人获取的webhook地址填写到url中即可

grafana配置告警规则-Alert Rules
进入监控面板dashboard
选择一个面板，edit进入，选择alert
    Condition 选项中是配置监控指标的报警限制：
    监控数据的什么指标（when）从此时开始1分钟内（query（A，1m，now））超出阈值（is above），则进行告警
    如最大值（max()）
    Notifications选择接收方式，message填写接收内容
    保存即可
```