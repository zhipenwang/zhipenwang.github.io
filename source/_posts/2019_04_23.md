---
title: redis：内存满了你能怎么办
date: 2019-04-23
tags: redis
categories: redis
---
>redis是纯内存，key-value的数据库。

解决方法：
1. 增加内存
2. 使用内存淘汰策略（LRU）
3. Redis集群

*第一点是最笨的方法，耗钱耗资源，适合有钱的大佬😂，本文主要讲解第二点跟第三点。*

### 使用内存淘汰策略（LRU）
>redis设置配置文件的maxmemory参数，可以控制其最大可以用的内存大小（字节）。  
>当所需内存超过了maxmemory后，需要去修改配置文件的maxmemory-policy参数了。

maxmemory-policy，默认值为【noeviction】，下列为删除redis键具有的淘汰规则。
>LRU算法，least RecentlyUsed，最近最少使用算法。也就是说默认删除最近最少使用的键。

规则名称|规则说明
--|--
volatile-lru|使用LRU算法删除一个键（只对设置了生存时间的键），最少使用的
allkeys-lru|使用LRU算法删除一个键，最少使用的
volatile-random|随机删除一个键（只对设置了生存长时间的键）
allkeys-random|随机删除一个键
volatile-ttl|删除生存时间最近的一个键
noeviction|不删除键，只返回错误

>作为内存数据库，出于对性能和内存消耗的考虑，Redis 的淘汰算法实际实现上并非针对所有 key，而是抽样一小部分并且从中选出被淘汰的 key。
>
>使用 Redis 缓存数据时，为了提高缓存命中率，需要保证缓存数据都是热点数据。可以将内存最大使用量设置为热点数据占用的内存量，然后启用 allkeys-lru 淘汰策略，将最近最少使用的数据淘汰。
>
>Redis 4.0 引入了 volatile-lfu 和 allkeys-lfu 淘汰策略，LFU 策略通过统计访问频率，将访问频率最少的键值对淘汰。

但是一定要注意一点！redis中并不会准确的删除所有键中最近最少使用的键，而是随机抽取3个键，删除这三个键中最近最少使用的键。  
那么3这个数字也是可以设置的，对应位置是配置文件中的maxmeory-samples.

### Redis集群
*Redis仅支持单实例，内存一般最多10~20GB。对于内存动辄100~200GB的系统，就需要通过集群来支持了。*

Redis集群有三种方式：客户端分片、代理分片、RedisCluster。
#### 客户端分片
通过业务代码自己实现路由
>优势：可以自己控制分片算法、性能比代理的好  
>劣势：维护成本高、扩容/缩容等运维操作都需要自己研发

#### 代理分片（redis中间件）
代理程序接收到来自业务程序的数据请求，根据路由规则，将这些请求分发给正确的Redis实例并返回给业务程序。使用类似Twemproxy、Codis等中间件实现。
>优势：运维方便、程序不用关心如何链接Redis实例  
>劣势：会带来性能消耗（大概20%）、无法平滑扩容/缩容，需要执行脚本迁移数据，不方便(Codis在Twemproxy基础上优化并实现了预分片来达到Auto Rebalance)。

#### Redis Cluster
>优势：官方集群解决方案、无中心节点，和客户端直连，性能较好  
>劣势：方案太重、无法平滑扩容/缩容，需要执行相应的脚本，不方便、太新，没有相应成熟的解决案例