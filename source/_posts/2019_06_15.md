---
title: PHP使用KAFKA
date: 2019-06-15
tags: [KAFKA,PHP]
categories: KAFKA
---

### 环境部署（PHP-RdKafka扩展）
*上一节说了KAFKA的单节点部署，本节就不再细述了。*
为了允许KAFKA被PHP远程调用，需要修改KAFKA配置
```
在kafka的server.properties中修改如下kafka配置项：
    advertised.listeners=PLAINTEXT://ip:port
默认该项配置是注释掉的，如果不修改的话，kafka默认使用listeners配置项或者localhost+port来生产或者消费消息
重启KAFKA
```

安装lib库
```
git clone https://github.com/edenhill/librdkafka.git
./configure
make
make install
```

安装php-kafka扩展
```
git clone https://github.com/arnaud-lb/php-rdkafka.git
cd php-rdkafka
phpize
./configure --with-php-config=/usr/local/bin/php-config
make && make install
在php.ini中加入：
extension=rdkafka.so
重启php-fpm
```

### PHP-RdKAFKA使用
PHP-生产
```
<?php
try {
	$rcf = new RdKafka\Conf();
	$rcf->set('group.id', 'test');
	$cf = new RdKafka\TopicConf();
	$cf->set('offset.store.method', 'broker');
	$cf->set('auto.offset.reset', 'smallest');

	$rk = new RdKafka\Producer($rcf);
	$rk->setLogLevel(LOG_DEBUG);
	$rk->addBrokers("127.0.0.1:9092");
	$topic = $rk->newTopic("test", $cf);

	for($i = 0; $i < 10; $i++) {
		$topic->produce(0,0,'test' . $i);
	} 
}catch (Exception $e) {
	echo $e->getMessage();
}
```

PHP-消费
```
<?php
try {
    $rcf = new RdKafka\Conf();
    $rcf->set('group.id', 'test');
	$cf = new RdKafka\TopicConf();
    $cf->set('auto.offset.reset', 'smallest');
    $cf->set('auto.commit.enable', true);
 
    $rk = new RdKafka\Consumer($rcf);
    $rk->setLogLevel(LOG_DEBUG);
    $rk->addBrokers("127.0.0.1:9092");
    $topic = $rk->newTopic("test", $cf);
    while (true) {
        $topic->consumeStart(0, RD_KAFKA_OFFSET_STORED);
        $msg = $topic->consume(0, 1000);
        var_dump($msg);
        if (isset($msg->err) && $msg->err) {
            echo $msg->errstr(), "\n";
        } elseif(isset($msg->payload)) {
            echo $msg->payload, "\n";
        }
        $topic->consumeStop(0);
        sleep(1);
    }
} catch (Exception $e) {
    echo $e->getMessage();
}
```

### 扩展
PHP-RdKAKFA消费KAFKA的时候，有两种方式，低级方式与高级方式，在下节会展开讨论。